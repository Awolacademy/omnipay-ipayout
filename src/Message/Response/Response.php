<?php

namespace Omnipay\iPayout\Message\Response;

use Omnipay\Common\Message\AbstractResponse;
use Omnipay\Common\Message\RequestInterface;

/**
 * Response
 */
class Response extends AbstractResponse
{    
    /**
     * Constructor
     *
     * @param RequestInterface $request the initiating request.
     * @param mixed $data
     */
    public function __construct(RequestInterface $request, $data)
    {
        $data = json_decode(json_encode($data), FALSE);
        parent::__construct($request, (object)$data);
    }
    
    /**
     * @return bool
     */
    public function isSuccessful()
    {
        return !$this->isError() && $this->getResponse() && $this->data->response->m_Code === 0;
    }
    
    /**
     * @return bool
     */
    public function getResponse()
    {
        return isset($this->data->response) ? $this->data->response : NULL;
    }

    /**
     * @return bool
     */
    public function isRedirect()
    {
        return false;
    }

    /**
     * Get the transaction ID as generated by the merchant website.
     *
     * @return string
     */
    public function getTransactionId()
    {
        return ($this->getResponse() && isset($this->data->response->TransactionRefID) ) ? $this->data->response->TransactionRefID : null;
    }

    /**
     * @return null|string
     */
    public function getMessage()
    {
        $errors = array();
        if (!$this->isSuccessful()) {
            if (!$this->getResponse() && isset($this->data->Message)) {
                $errors[] = $this->data->Message;
            }
            $err = $this->getResponseText();
            if (!is_null($err)) {
                $errors[] = $this->getResponseText();
            }
        }
        
        if (empty($errors)) {
            return null;
        }

        return implode($errors, '; ');
    }

    /**
     * Response text
     *
     * @return null|string A response code from the payment gateway
     */
    public function getResponseText()
    {
        return ($this->getResponse() && isset($this->data->response->m_Text) ) ? $this->data->response->m_Text : null;
    }

    /**
     * Response code
     *
     * @return null|string A response code from the payment gateway
     */
    public function getCode()
    {
        // m_Code
        return ($this->getResponse() && isset($this->data->response->m_Code) ) ? (int)$this->data->response->m_Code : null;
    }
    
    public function isError() {
        return isset($this->data->IsError) && $this->data->IsError == 1 ? true : false;
    }
}
